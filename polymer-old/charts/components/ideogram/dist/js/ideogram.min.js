function Range(t){this._data=t}function ModelAdapter(t){this._model=t,this._class="ModelAdapter"}function ModelNoBandsAdapter(t){ModelAdapter.call(this,t),this._class="ModelNoBandsAdapter"}function Layout(t,o){if(this._config=t,this._ideo=o,this._ploidy=this._ideo._ploidy,this._translate=void 0,"chrSetMargin"in t)this.chrSetMargin=t.chrSetMargin;else{var e=this._config.chrMargin;this.chrSetMargin=this._config.ploidy>1?e:0}this._tickSize=8,this._isRotated=!1}function HorizontalLayout(t,o){Layout.call(this,t,o),this._class="HorizontalLayout",this._margin={left:20,top:30}}function VerticalLayout(t,o){Layout.call(this,t,o),this._class="VerticalLayout",this._margin={top:30,left:15}}function PairedLayout(t,o){Layout.call(this,t,o),this._class="PairedLayout",this._margin={left:30}}function SmallLayout(t,o){Layout.call(this,t,o),this._class="SmallLayout",this._margin={left:36.5,top:10}}function Ploidy(t){this._config=t,this._description=this._normalize(this._config.ploidyDesc)}function Color(t){this._config=t,this._ploidy=new Ploidy(this._config)}function Chromosome(t,o,e){this._adapter=t,this._model=this._adapter.getModel(),this._config=o,this._ideo=e,this._color=new Color(this._config),this._bumpCoefficient=5}function TelocentricChromosome(t,o,e){Chromosome.call(this,t,o,e),this._class="TelocentricChromosome",this._pArmOffset=3}function MetacentricChromosome(t,o,e){Chromosome.call(this,t,o,e),this._class="MetacentricChromosome"}function naturalSort(t,o){var e,n,r=/(^([+\-]?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?(?=\D|\s|$))|^0x[\da-fA-F]+$|\d+)/g,i=/^\s+|\s+$/g,s=/\s+/g,a=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,c=/^0x[0-9a-f]+$/i,l=/^0/,h=function(t){return(naturalSort.insensitive&&(""+t).toLowerCase()||""+t).replace(i,"")},d=h(t),u=h(o),m=d.replace(r,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),p=u.replace(r,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),f=parseInt(d.match(c),16)||1!==m.length&&Date.parse(d),g=parseInt(u.match(c),16)||f&&u.match(a)&&Date.parse(u)||null,y=function(t,o){return(!t.match(l)||1==o)&&parseFloat(t)||t.replace(s," ").replace(i,"")||0};if(g){if(f<g)return-1;if(f>g)return 1}for(var b=0,_=m.length,x=p.length,v=Math.max(_,x);b<v;b++){if(e=y(m[b]||"",_),n=y(p[b]||"",x),isNaN(e)!==isNaN(n))return isNaN(e)?1:-1;if(/[^\x00-\x80]/.test(e+n)&&e.localeCompare){var C=e.localeCompare(n);return C/Math.abs(C)}if(e<n)return-1;if(e>n)return 1}}function slugify(t){return t.toLowerCase().replace(" ","-")}function ChromosomeUtil(t){this._node=t}Range.prototype.getStart=function(){return this._data.start},Range.prototype.getStop=function(){return this._data.stop},Range.prototype.getLength=function(){return this._data.stop-this._data.start},Range.prototype.getColor=function(t){return"ploidy"in this._data?"ploidy"in this._data&&this._data.ploidy[t]?this._getColor(t):"transparent":this._getColor(t)},Range.prototype._getColor=function(t){return Array.isArray(this._data.color)?this._data.color[t]:this._data.color},ModelAdapter.getInstance=function(t){return t.bands?new ModelAdapter(t):new ModelNoBandsAdapter(t)},ModelAdapter.prototype.getModel=function(){return this._model},ModelAdapter.prototype.getCssClass=function(){return""},ModelNoBandsAdapter.prototype=Object.create(ModelAdapter.prototype),ModelNoBandsAdapter.prototype.getModel=function(){return this._model.bands=[],this._model.width>1&&this._model.bands.push({name:"q",px:{start:0,stop:this._model.width,width:this._model.width}}),this._model},ModelNoBandsAdapter.prototype.getCssClass=function(){return"noBands"},Layout.getInstance=function(t,o){return"perspective"in t&&"comparative"===t.perspective?new PairedLayout(t,o):"rows"in t&&t.rows>1?new SmallLayout(t,o):"vertical"===t.orientation?new VerticalLayout(t,o):"horizontal"===t.orientation?new HorizontalLayout(t,o):new VerticalLayout(t,o)},Layout.prototype._getLeftMargin=function(){return this._margin.left},Layout.prototype._getYScale=function(){return 20/this._config.chrWidth},Layout.prototype.getChromosomeLabels=function(t){var o=new ChromosomeUtil(t);return[o.getSetLabel(),o.getLabel()].filter(function(t){return t.length>0})},Layout.prototype.rotateBack=function(){throw new Error(this._class+"#rotateBack not implemented")},Layout.prototype.rotateForward=function(){throw new Error(this._class+"#rotateForward not implemented")},Layout.prototype.rotate=function(t,o,e){var n=this._ideo,r=d3.selectAll(n.selector+" g.chromosome").filter(function(){return this!==e});this._isRotated?(this._isRotated=!1,this.rotateBack(t,o,e,function(){r.style("display",null),d3.selectAll(n.selector+" .chrSetLabel, .chrLabel").style("display",null)})):(this._isRotated=!0,r.style("display","none"),d3.selectAll(n.selector+" .chrSetLabel, .chrLabel").style("display","none"),this.rotateForward(t,o,e))},Layout.prototype.getChromosomeLabelClass=function(){return 1===this._config.ploidy?"chrLabel":"chrSetLabel"},Layout.prototype._getAdditionalOffset=function(){return(this._config.annotationHeight||0)*(this._config.numAnnotTracks||1)},Layout.prototype._getChromosomeSetSize=function(t){var o=this._ploidy.getSetSize(t);return o*this._config.chrWidth*2+this.chrSetMargin},Layout.prototype.getMargin=function(){return this._margin},Layout.prototype.getHeight=function(){throw new Error(this._class+"#getHeight not implemented")},Layout.prototype.getChromosomeBandTickY1=function(){throw new Error(this._class+"#getChromosomeBandTickY1 not implemented")},Layout.prototype.getChromosomeBandTickY2=function(){throw new Error(this._class+"#getChromosomeBandTickY2 not implemented")},Layout.prototype.getChromosomeBandLabelTranslate=function(){throw new Error(this._class+"#getChromosomeBandLabelTranslate not implemented")},Layout.prototype.getChromosomeSetLabelAnchor=function(){return"middle"},Layout.prototype.getChromosomeBandLabelAnchor=function(){throw new Error(this._class+"#getChromosomeBandLabelAnchor not implemented")},Layout.prototype.getChromosomeLabelXPosition=function(){throw new Error(this._class+"#getChromosomeLabelXPosition not implemented")},Layout.prototype.getChromosomeLabelYPosition=function(){return-5.5},Layout.prototype.getChromosomeSetLabelYPosition=function(t){return 1===this._config.ploidy?this.getChromosomeLabelYPosition(t):-2*this._config.chrWidth},Layout.prototype.getChromosomeSetLabelXPosition=function(){throw new Error(this._class+"#getChromosomeSetLabelXPosition not implemented")},Layout.prototype.getChromosomeSetLabelTranslate=function(){throw new Error(this._class+"#getChromosomeSetLabelTranslate not implemented")},Layout.prototype.getChromosomeSetTranslate=function(){throw new Error(this._class+"#getChromosomeSetTranslate not implemented")},Layout.prototype.getChromosomeSetYTranslate=function(){throw new Error(this._class+"#getChromosomeSetYTranslate not implemented")},HorizontalLayout.prototype=Object.create(Layout.prototype),HorizontalLayout.prototype._getLeftMargin=function(){var t=Layout.prototype._getLeftMargin.call(this);return this._config.ploidy>1&&(t*=1.8),t},HorizontalLayout.prototype.rotateForward=function(t,o,e,n){var r=30,i=d3.select(this._ideo.selector).node().getBoundingClientRect(),s=e.getBoundingClientRect(),a=i.height/(s.width+r/2)*.9,c=this._getYScale(),l=(o+1)*(2*this._config.chrWidth*c),h="rotate(90) translate("+r+", -"+l+") scale("+a+", "+c+")";d3.select(e.parentNode).transition().attr("transform",h).on("end",n);var d=this.getChromosomeLabels(e);d3.select(this._ideo.getSvg()).append("g").attr("class","tmp").selectAll("text").data(d).enter().append("text").attr("class",function(t,o){return 0===o&&2===d.length?"chrSetLabel":null}).attr("x",30).attr("y",function(t,o){return 12*(o+1+d.length%2)}).style("text-anchor","middle").style("opacity",0).text(String).transition().style("opacity",1)},HorizontalLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",n),d3.selectAll(this._ideo.selector+" g.tmp").style("opacity",0).remove()},HorizontalLayout.prototype.getHeight=function(t){var o=this._config.chromosomes[t].length,e=this.getChromosomeSetYTranslate(o-1),n=this._getChromosomeSetSize(o-1);return e+=n,e+2*this._getAdditionalOffset()},HorizontalLayout.prototype.getWidth=function(){return this._config.chrHeight+1.5*this._margin.top},HorizontalLayout.prototype.getChromosomeSetLabelAnchor=function(){return"end"},HorizontalLayout.prototype.getChromosomeBandLabelAnchor=function(){return null},HorizontalLayout.prototype.getChromosomeBandTickY1=function(){return 2},HorizontalLayout.prototype.getChromosomeBandTickY2=function(){return 10},HorizontalLayout.prototype.getChromosomeBandLabelTranslate=function(t){var o=this._ideo.round(-this._tickSize+t.px.start+t.px.width/2),e=-10;return{x:o,y:e,translate:"translate("+o+","+e+")"}},HorizontalLayout.prototype.getChromosomeSetLabelTranslate=function(){return null},HorizontalLayout.prototype.getChromosomeSetTranslate=function(t){var o=this._getLeftMargin(),e=this.getChromosomeSetYTranslate(t);return"translate("+o+", "+e+")"},HorizontalLayout.prototype.getChromosomeSetYTranslate=function(t){if(!this._config.ploidyDesc)return this._config.chrMargin*(t+1);if(!this._translate){this._translate=[1];for(var o=1;o<this._config.ploidyDesc.length;o++)this._translate[o]=this._translate[o-1]+this._getChromosomeSetSize(o-1)}return this._translate[t]},HorizontalLayout.prototype.getChromosomeSetLabelXPosition=function(t){return 1===this._config.ploidy?this.getChromosomeLabelXPosition(t):-20},HorizontalLayout.prototype.getChromosomeSetLabelYPosition=function(t){var o=this._ploidy.getSetSize(t),e=this._config,n=e.chrMargin,r=e.chrWidth;return 1===e.ploidy?y=r/2+3:y=o*n/2,y},HorizontalLayout.prototype.getChromosomeLabelXPosition=function(){return-8},HorizontalLayout.prototype.getChromosomeLabelYPosition=function(){return this._config.chrWidth},VerticalLayout.prototype=Object.create(Layout.prototype),VerticalLayout.prototype.rotateForward=function(t,o,e,n){var r=this,i=20,s=d3.select(this._ideo.selector).node().getBoundingClientRect(),a=e.getBoundingClientRect(),c=s.width/a.height*.97,l=this._getYScale(),h="translate("+i+", 25) scale("+c+", "+l+")";d3.select(e.parentNode).transition().attr("transform",h).on("end",n);var d=this.getChromosomeLabels(e),u=1.3*(i+r._config.chrWidth);d3.select(this._ideo.getSvg()).append("g").attr("class","tmp").selectAll("text").data(d).enter().append("text").attr("class",function(t,o){return 0===o&&2===d.length?"chrSetLabel":null}).attr("x",0).attr("y",u).style("opacity",0).text(String).transition().style("opacity",1)},VerticalLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",n),d3.selectAll(this._ideo.selector+" g.tmp").style("opacity",0).remove()},VerticalLayout.prototype.getHeight=function(){return this._config.chrHeight+1.5*this._margin.top},VerticalLayout.prototype.getWidth=function(){return"97%"},VerticalLayout.prototype.getChromosomeBandLabelTranslate=function(){},VerticalLayout.prototype.getChromosomeSetLabelTranslate=function(){return"rotate(-90)"},VerticalLayout.prototype.getChromosomeSetTranslate=function(t){var o=this._margin.top,e=this.getChromosomeSetYTranslate(t);return"rotate(90) translate("+o+", -"+e+")"},VerticalLayout.prototype.getChromosomeSetYTranslate=function(t){var o,e=this._getAdditionalOffset(),n=this._config.chrMargin,r=this._config.chrWidth;if(!this._config.ploidyDesc)return"histogram"===this._config.annotationsLayout?n/2+t*(n+r+2)+2*e+1:(o=r+t*(n+r)+2*e,e>0?o:o+4+2*t);if(!this._translate){this._translate=[this._ploidy.getSetSize(0)*r*2];for(var i,s=1;s<this._config.ploidyDesc.length;s++)i=this._translate[s-1],this._translate[s]=i+this._getChromosomeSetSize(s-1)}return this._translate[t]},VerticalLayout.prototype.getChromosomeSetLabelXPosition=function(){return this._config.chrWidth*this._config.ploidy/-2},VerticalLayout.prototype.getChromosomeLabelXPosition=function(){return this._config.chrWidth/-2},PairedLayout.prototype=Object.create(Layout.prototype),PairedLayout.prototype.rotateForward=function(t,o,e,n){var r=this,i=this._ideo,s=d3.select(i.selector).node().getBoundingClientRect(),a=e.getBoundingClientRect(),c=s.width/a.height*.97,l=this._getYScale(),h=t?150:25,d="translate(15, "+h+") scale("+c+", "+l+")";d3.select(e.parentNode).transition().attr("transform",d).on("end",function(){n&&n();var o=6*Number(!t);d3.select(e.parentNode).selectAll("g.bandLabel text").attr("transform","rotate(90) translate(0, "+o+")").attr("text-anchor","middle"),d3.selectAll(i.selector+" .syntenicRegion").style("display","none")});var u=this.getChromosomeLabels(e);d3.select(this._ideo.getSvg()).append("g").attr("class","tmp").selectAll("text").data(this.getChromosomeLabels(e)).enter().append("text").attr("class",function(t,o){return 0===o&&2===u.length?"chrSetLabel":null}).attr("x",0).attr("y",h+r._config.chrWidth*c/2*1.15).style("opacity",0).text(String).transition().style("opacity",1)},PairedLayout.prototype.rotateBack=function(t,o,e,n){var r=this._ideo,i=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",i).on("end",function(){n(),d3.selectAll(r.select+" .syntenicRegion").style("display",null),d3.select(e.parentNode).selectAll("g.bandLabel text").attr("transform",null).attr("text-anchor",t?null:"end")}),d3.selectAll(r.selector+" g.tmp").style("opacity",0).remove()},PairedLayout.prototype.getHeight=function(){return this._config.chrHeight+1.5*this._margin.left},PairedLayout.prototype.getWidth=function(){return"97%"},PairedLayout.prototype.getChromosomeBandTickY1=function(t){return t%2?this._config.chrWidth:2*this._config.chrWidth},PairedLayout.prototype.getChromosomeBandTickY2=function(t){var o=this._config.chrWidth;return t%2?o-this._tickSize:2*o+this._tickSize},PairedLayout.prototype.getChromosomeBandLabelAnchor=function(t){return t%2?null:"end"},PairedLayout.prototype.getChromosomeBandLabelTranslate=function(t,o){var e=o%2?10:-this._config.chrWidth-10,n=this._ideo.round(t.px.start+t.px.width/2)+3;return{x:n,y:n,translate:"rotate(-90) translate("+e+", "+n+")"}},PairedLayout.prototype.getChromosomeLabelXPosition=function(){return-this._tickSize},PairedLayout.prototype.getChromosomeSetLabelXPosition=function(){return this._config.chrWidth/-2},PairedLayout.prototype.getChromosomeSetLabelTranslate=function(){return"rotate(-90)"},PairedLayout.prototype.getChromosomeSetTranslate=function(t){var o=this.getChromosomeSetYTranslate(t);return"rotate(90) translate("+this._margin.left+", -"+o+")"},PairedLayout.prototype.getChromosomeSetYTranslate=function(t){return 200*(t+1)},SmallLayout.prototype=Object.create(Layout.prototype),SmallLayout.prototype.rotateForward=function(t,o,e,n){var r=d3.select(this._ideo.selector).node().getBoundingClientRect(),i=e.getBoundingClientRect(),s=r.width/i.height*.97,a=this._getYScale();transform="translate(5, 25) scale("+s+", "+a+")",d3.select(e.parentNode).transition().attr("transform",transform).on("end",n)},SmallLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",n)},SmallLayout.prototype.getHeight=function(){return this._config.rows*(this._config.chrHeight+1.5*this._margin.top)},SmallLayout.prototype.getWidth=function(){return"97%"},SmallLayout.prototype.getChromosomeBandLabelTranslate=function(){},SmallLayout.prototype.getChromosomeSetLabelTranslate=function(){return"rotate(-90)"},SmallLayout.prototype.getChromosomeSetTranslate=function(t){var o=[];this._ideo.getTaxids(function(t){o=t});var e,n,r=this._ideo.config.chromosomes[o[0]].length,i=r/this._config.rows;return t>i-1?(e=this._margin.left+1.4*this._config.chrHeight,n=this.getChromosomeSetYTranslate(t-i)):(e=this._margin.left,n=this.getChromosomeSetYTranslate(t)),"rotate(90) translate("+e+", -"+n+")"},SmallLayout.prototype.getChromosomeSetYTranslate=function(t){var o=this._getAdditionalOffset();return this._margin.left*t+this._config.chrWidth+2*o+o*t},SmallLayout.prototype.getChromosomeSetLabelXPosition=function(t){return(this._ploidy.getSetSize(t)*this._config.chrWidth+20)/-2+(this._config.ploidy>1?0:this._config.chrWidth)},SmallLayout.prototype.getChromosomeLabelXPosition=function(){return this._config.chrWidth/-2},Ploidy.prototype.getChromosomesNumber=function(t){if(this._config.ploidyDesc){var o=this._config.ploidyDesc[t];return o instanceof Object?Object.keys(o)[0].length:o.length}return this._config.ploidy||1},Ploidy.prototype._normalize=function(t){var o,e,n;if(!t)return t;o=[];for(e in t)n=t[e],"string"==typeof n?("vertical"===this._config.orientation&&(n=n.split("").reverse()),o.push({ancestors:n,existence:this._getexistenceArray(n.length)})):o.push({ancestors:Object.keys(n)[0],existence:n[Object.keys(n)[0]]});return o},Ploidy.prototype._getexistenceArray=function(t){for(var o=[],e=0;e<t;e++)o.push("11");return o},Ploidy.prototype.getSetSize=function(t){return this._description?this._description[t].ancestors.length:1},Ploidy.prototype.getAncestor=function(t,o){return this._description?this._description[t].ancestors[o]:""},Ploidy.prototype.exists=function(t,o,e){if(this._description){var n=this._description[t].existence[o][e];return Number(n)>0}return!0},Color.prototype.getArmColor=function(t,o,e){return this._config.armColors?this._config.armColors[e]:this._config.ancestors?this._getPolyploidArmColor(t,o,e):null},Color.prototype.getBorderColor=function(t,o,e){return o<this._config.ploidy?"#000":this._ploidy.exists(t,o,e)?"#000":"#fff"},Color.prototype._getPolyploidArmColor=function(t,o,e){if(this._ploidy.exists(t,o,e)){var n=this._ploidy.getAncestor(t,o,e);return this._config.ancestors[n]}return"transparent"},Chromosome.getInstance=function(t,o,e){return"telocentric"===t.getModel().centromerePosition?new TelocentricChromosome(t,o,e):new MetacentricChromosome(t,o,e)},Chromosome.prototype._addPArmShape=function(t,o){return o?t.concat(this._getPArmShape()):t},Chromosome.prototype._addQArmShape=function(t,o){return o?t.concat(this._getQArmShape()):t},Chromosome.prototype.render=function(t,o,e){var n=this;t=t.append("g").attr("class","bands").attr("clip-path","url(#"+this._model.id+"-chromosome-set-clippath)");var r=this._renderPArm(t,o,e),i=this._renderQArm(t,o,e);this._renderRangeSet(t,o,e);var s=[];s=this._addPArmShape(s,r),s=this._addQArmShape(s,i);var a="0",c="",l=this.isFullyBanded();return"ancestors"in this._ideo.config&&!("rangeSet"in this._ideo.config)?(c=n._color.getArmColor(o,e,0),l&&(a="0.5")):l?(a=null,c="transparent"):"ancestors"in this._ideo.config||(a="1"),t.append("g").attr("class","chromosome-border").selectAll("path").data(s).enter().append("path").attr("fill",c).style("fill-opacity",a).attr("stroke",function(t,r){return n._color.getBorderColor(o,e,r)}).attr("stroke-width",function(t){return"strokeWidth"in t?t.strokeWidth:1}).attr("d",function(t){return t.path}).attr("class",function(t){return t.class}),s},Chromosome.prototype._renderRangeSet=function(t,o,e){if("rangeSet"in this._config){var n=this._config.rangeSet.filter(function(t){return t.chr-1===o}).map(function(t){return new Range(t)}),r=t.append("g").attr("class","range-set"),i=this,s=i._ideo,a=s._bandsXOffset;r.selectAll("rect.range").data(n).enter().append("rect").attr("class","range").attr("x",function(t){var o=s.convertBpToPx(i._model,t.getStart());return o-a}).attr("y",0).attr("width",function(t){var o=s.convertBpToPx(i._model,t.getLength());return o-a}).attr("height",this._config.chrWidth).style("fill",function(t){return t.getColor(e)})}},Chromosome.prototype._getShapeData=function(){for(var t,o=0;o<this._model.bands.length;o++)if("q"===this._model.bands[o].name[0]){t=this._model.bands[o];break}var e=this._model.bands.length-1,n=this._model.bands[e].px.stop;return{x1:0,x2:t?t.px.start:n,x3:n,w:this._config.chrWidth,b:this._config.chrWidth/this._bumpCoefficient}},Chromosome.prototype._getPArmShape=function(){var t=this._getShapeData(),o=t.x2-t.b;return this.isFullyBanded()||"ancestors"in this._ideo.config?{class:"",path:"M"+t.b+",0 L"+o+",0 Q"+(t.x2+t.b)+","+t.w/2+","+o+","+t.w+" L"+t.b+","+t.w+" Q-"+t.b+","+t.w/2+","+t.b+",0"}:[{class:"",path:"M"+t.b+",0 L"+(o-2)+",0 L"+(o-2)+","+t.w+" L"+t.b+","+t.w+" Q-"+t.b+","+t.w/2+","+t.b+",0"},{class:"acen",path:"M"+o+",0 Q"+(t.x2+t.b)+","+t.w/2+","+o+","+t.w+" L"+o+","+t.w+" L"+(o-2)+","+t.w+" L"+(o-2)+",0"}]},Chromosome.prototype._getQArmShape=function(){var t=this._getShapeData(),o=t.x3-t.b,e=t.x2+t.b;return this.isFullyBanded()||"ancestors"in this._ideo.config?{class:"",path:"M"+e+",0 L"+o+",0 Q"+(t.x3+t.b)+","+t.w/2+","+o+","+t.w+" L"+e+","+t.w+" Q"+(t.x2-t.b)+","+t.w/2+","+e+",0"}:[{path:"M"+e+",0 L"+o+",0 Q"+(t.x3+t.b)+","+t.w/2+","+o+","+t.w+" L"+e+","+t.w+" L"+e+",0"},{class:"acen",path:"M"+e+",0Q"+(t.x2-t.b)+","+t.w/2+","+e+","+t.w+" L"+e+","+t.w+"L"+(e+2)+","+t.w+"L"+(e+2)+",0"}]},Chromosome.prototype.isFullyBanded=function(){return this._model.bands&&(2!==this._model.bands.length||"q"===this._model.bands[0].name[0])},Chromosome.prototype._renderBands=function(t,o,e,n,r){var i=this,s="p"===r?0:1,a="";"ancestors"in this._ideo.config&&!this.isFullyBanded()&&(a=i._color.getArmColor(o,e,s)),t.selectAll("path.band."+r).data(n).enter().append("path").attr("id",function(t){return i._model.id+"-"+t.name.replace(".","-")}).attr("class",function(t){return"band "+r+"-band "+t.stain}).attr("d",function(t){var o=i._ideo.round(t.px.start),e=i._ideo.round(t.px.width);return x=o+e,"M "+o+", 0l "+e+" 0 l 0 "+i._config.chrWidth+" l -"+e+" 0 z"}).style("fill",a)},Chromosome.prototype._renderPArm=function(t,o,e){var n=this._model.bands.filter(function(t){return"p"===t.name[0]});return this._renderBands(t,o,e,n,"p"),Boolean(n.length)},Chromosome.prototype._renderQArm=function(t,o,e){var n=this._model.bands.filter(function(t){return"q"===t.name[0]});return this._renderBands(t,o,e,n,"q"),Boolean(n.length)},TelocentricChromosome.prototype=Object.create(Chromosome.prototype),TelocentricChromosome.prototype._addPArmShape=function(t){return t.concat(this._getPArmShape())},TelocentricChromosome.prototype._getPArmShape=function(){var t=this._getShapeData();return t.o=this._pArmOffset,[{class:"acen",path:"M"+(t.x2+2)+",1L"+(t.x2+t.o+3.25)+",1 L"+(t.x2+t.o+3.25)+","+(t.w-1)+" L"+(t.x2+2)+","+(t.w-1)},{class:"gpos66",path:"M"+(t.x2-t.o+5)+",0L"+(t.x2-t.o+3)+",0 L"+(t.x2-t.o+3)+","+t.w+" L"+(t.x2-t.o+5)+","+t.w,strokeWidth:.5}]},TelocentricChromosome.prototype._getQArmShape=function(){var t=this._getShapeData(),o=t.x3-t.b,e=this._pArmOffset+3;return{class:"",path:"M"+(t.x2+e)+",0 L"+o+",0 Q"+(t.x3+t.b)+","+t.w/2+","+o+","+t.w+" L"+(t.x2+e)+","+t.w}},MetacentricChromosome.prototype=Object.create(Chromosome.prototype),function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function o(t){return"function"==typeof t}function e(t){X=t}function n(t){U=t}function r(){return function(){process.nextTick(l)}}function i(){return function(){E(l)}}function s(){var t=0,o=new J(l),e=document.createTextNode("");return o.observe(e,{characterData:!0}),function(){e.data=t=++t%2}}function a(){var t=new MessageChannel;return t.port1.onmessage=l,function(){t.port2.postMessage(0)}}function c(){return function(){setTimeout(l,1)}}function l(){for(var t=0;q>t;t+=2){var o=tt[t],e=tt[t+1];o(e),tt[t]=void 0,tt[t+1]=void 0}q=0}function h(){try{var t=require,o=t("vertx");return E=o.runOnLoop||o.runOnContext,i()}catch(t){return c()}}function d(t,o){var e=this,n=new this.constructor(m);void 0===n[nt]&&D(n);var r=e._state;if(r){var i=arguments[r-1];U(function(){P(r,n,i,e._result)})}else A(e,n,t,o);return n}function u(t){var o=this;if(t&&"object"==typeof t&&t.constructor===o)return t;var e=new o(m);return v(e,t),e}function m(){}function p(){return new TypeError("You cannot resolve a promise with itself")}function f(){return new TypeError("A promises callback cannot return that same promise.")}function g(t){try{return t.then}catch(t){return at.error=t,at}}function y(t,o,e,n){try{t.call(o,e,n)}catch(t){return t}}function b(t,o,e){U(function(t){var n=!1,r=y(e,o,function(e){n||(n=!0,o!==e?v(t,e):L(t,e))},function(o){n||(n=!0,w(t,o))},"Settle: "+(t._label||" unknown promise"));!n&&r&&(n=!0,w(t,r))},t)}function _(t,o){o._state===it?L(t,o._result):o._state===st?w(t,o._result):A(o,void 0,function(o){v(t,o)},function(o){w(t,o)})}function x(t,e,n){e.constructor===t.constructor&&n===ot&&constructor.resolve===et?_(t,e):n===at?w(t,at.error):void 0===n?L(t,e):o(n)?b(t,e,n):L(t,e)}function v(o,e){o===e?w(o,p()):t(e)?x(o,e,g(e)):L(o,e)}function C(t){t._onerror&&t._onerror(t._result),S(t)}function L(t,o){t._state===rt&&(t._result=o,t._state=it,0!==t._subscribers.length&&U(S,t))}function w(t,o){t._state===rt&&(t._state=st,t._result=o,U(C,t))}function A(t,o,e,n){var r=t._subscribers,i=r.length;t._onerror=null,r[i]=o,r[i+it]=e,r[i+st]=n,0===i&&t._state&&U(S,t)}function S(t){var o=t._subscribers,e=t._state;if(0!==o.length){for(var n,r,i=t._result,s=0;s<o.length;s+=3)n=o[s],r=o[s+e],n?P(e,n,r,i):r(i);t._subscribers.length=0}}function B(){this.error=null}function T(t,o){try{return t(o)}catch(t){return ct.error=t,ct}}function P(t,e,n,r){var i,s,a,c,l=o(n);if(l){if(i=T(n,r),i===ct?(c=!0,s=i.error,i=null):a=!0,e===i)return void w(e,f())}else i=r,a=!0;e._state!==rt||(l&&a?v(e,i):c?w(e,s):t===it?L(e,i):t===st&&w(e,i))}function M(t,o){try{o(function(o){v(t,o)},function(o){w(t,o)})}catch(o){w(t,o)}}function k(){return lt++}function D(t){t[nt]=lt++,t._state=void 0,t._result=void 0,t._subscribers=[]}function I(t){return new pt(this,t).promise}function N(t){var o=this;return new o(V(t)?function(e,n){for(var r=t.length,i=0;r>i;i++)o.resolve(t[i]).then(e,n)}:function(t,o){o(new TypeError("You must pass an array to race."))})}function F(t){var o=this,e=new o(m);return w(e,t),e}function H(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function W(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function O(t){this[nt]=k(),this._result=this._state=void 0,this._subscribers=[],m!==t&&("function"!=typeof t&&H(),this instanceof O?M(this,t):W())}function Y(t,o){this._instanceConstructor=t,this.promise=new t(m),this.promise[nt]||D(this.promise),V(o)?(this._input=o,this.length=o.length,this._remaining=o.length,this._result=new Array(this.length),0===this.length?L(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&L(this.promise,this._result))):w(this.promise,j())}function j(){return new Error("Array Methods must be provided an Array")}function z(){var t;if("undefined"!=typeof global)t=global;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var o=t.Promise;(!o||"[object Promise]"!==Object.prototype.toString.call(o.resolve())||o.cast)&&(t.Promise=mt)}var R;R=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var E,X,Q,V=R,q=0,U=function(t,o){tt[q]=t,tt[q+1]=o,q+=2,2===q&&(X?X(l):Q())},G="undefined"!=typeof window?window:void 0,$=G||{},J=$.MutationObserver||$.WebKitMutationObserver,K="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Z="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,tt=new Array(1e3);Q=K?r():J?s():Z?a():void 0===G&&"function"==typeof require?h():c();var ot=d,et=u,nt=Math.random().toString(36).substring(16),rt=void 0,it=1,st=2,at=new B,ct=new B,lt=0,ht=I,dt=N,ut=F,mt=O;O.all=ht,O.race=dt,O.resolve=et,O.reject=ut,O._setScheduler=e,O._setAsap=n,O._asap=U,O.prototype={constructor:O,then:ot,catch:function(t){return this.then(null,t)}};var pt=Y;Y.prototype._enumerate=function(){for(var t=this.length,o=this._input,e=0;this._state===rt&&t>e;e++)this._eachEntry(o[e],e)},Y.prototype._eachEntry=function(t,o){var e=this._instanceConstructor,n=e.resolve;if(n===et){var r=g(t);if(r===ot&&t._state!==rt)this._settledAt(t._state,o,t._result);else if("function"!=typeof r)this._remaining--,this._result[o]=t;else if(e===mt){var i=new e(m);x(i,t,r),this._willSettleAt(i,o)}else this._willSettleAt(new e(function(o){o(t)}),o)}else this._willSettleAt(n(t),o)},Y.prototype._settledAt=function(t,o,e){var n=this.promise;n._state===rt&&(this._remaining--,t===st?w(n,e):this._result[o]=e),0===this._remaining&&L(n,this._result)},Y.prototype._willSettleAt=function(t,o){var e=this;A(t,void 0,function(t){e._settledAt(it,o,t)},function(t){e._settledAt(st,o,t)})};var ft=z,gt={Promise:mt,polyfill:ft};"function"==typeof define&&define.amd?define(function(){return gt}):"undefined"!=typeof module&&module.exports?module.exports=gt:"undefined"!=typeof this&&(this.ES6Promise=gt),ft()}.call(this),!function(t,o){"function"==typeof define&&define.amd?define(["d3"],o):"object"==typeof exports?module.exports=o(require("d3")):t.d3.promise=o(t.d3)}(this,function(t){var o=function(){function o(t,o){return function(){var e=Array.prototype.slice.call(arguments);return new Promise(function(n,r){var i=function(t,o){return t?void r(Error(t)):void n(o)};o.apply(t,e.concat(i))})}}var e={};return["csv","tsv","json","xml","text","html","get"].forEach(function(n){e[n]=o(t,t[n])}),e}();return t.promise=o,o});var Ideogram=function(t){var o,e,n,r,i;this.config=JSON.parse(JSON.stringify(t)),this._bandsXOffset=30,this.debug=!1,this.config.dataDir||(this.config.dataDir="../data/bands/native/"),this.config.ploidy||(this.config.ploidy=1),this.config.ploidy>1&&(this.sexChromosomes={},this.config.sex||(this.config.sex="male"),2!==this.config.ploidy||this.config.ancestors||(this.config.ancestors={M:"#ffb6c1",P:"#add8e6"},this.config.ploidyDesc="MP")),this.config.container||(this.config.container="body"),this.selector=this.config.container+" #_ideogram",this.config.resolution||(this.config.resolution=850),"showChromosomeLabels"in this.config==!1&&(this.config.showChromosomeLabels=!0),this.config.orientation||(o="vertical",this.config.orientation=o),this.config.chrHeight||(r=this.config.container,i=document.querySelector(r).getBoundingClientRect(),n="vertical"===o?i.height:i.width,"body"===r&&(n=500),this.config.chrHeight=n),this.config.chrWidth||(e=10,n=this.config.chrHeight,n<900&&n>500?e=Math.round(n/40):n>=900&&(e=Math.round(n/45)),this.config.chrWidth=e),this.config.chrMargin||(1===this.config.ploidy?this.config.chrMargin=10:this.config.chrMargin=Math.round(this.config.chrWidth/4)),this.config.showBandLabels||(this.config.showBandLabels=!1),"showFullyBanded"in this.config?this.config.showFullyBanded=this.config.showFullyBanded:this.config.showFullyBanded=!0,this.config.brush||(this.config.brush=!1),this.config.rows||(this.config.rows=1),this.bump=Math.round(this.config.chrHeight/125),this.adjustedBump=!1,this.config.chrHeight<200&&(this.adjustedBump=!0,this.bump=4),t.showBandLabels&&(this.config.chrMargin+=20),t.chromosome&&(this.config.chromosomes=[t.chromosome],"showBandLabels"in t==!1&&(this.config.showBandLabels=!0),"rotatable"in t==!1&&(this.config.rotatable=!1)),this.config.showNonNuclearChromosomes||(this.config.showNonNuclearChromosomes=!1),this.initAnnotSettings(),this.config.chrMargin=this.config.chrMargin+this.config.chrWidth+2*this.config.annotTracksHeight,t.onLoad&&(this.onLoadCallback=t.onLoad),t.onDrawAnnots&&(this.onDrawAnnotsCallback=t.onDrawAnnots),t.onBrushMove&&(this.onBrushMoveCallback=t.onBrushMove),this.coordinateSystem="iscn",this.maxLength={bp:0,iscn:0},this.eutils="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/",this.esearch=this.eutils+"esearch.fcgi?retmode=json",this.esummary=this.eutils+"esummary.fcgi?retmode=json",this.elink=this.eutils+"elink.fcgi?retmode=json",this.organisms={9606:{commonName:"Human",scientificName:"Homo sapiens",
scientificNameAbbr:"H. sapiens",assemblies:{default:"GCF_000001405.26",GRCh38:"GCF_000001405.26",GRCh37:"GCF_000001405.13"}},10090:{commonName:"Mouse",scientificName:"Mus musculus",scientificNameAbbr:"M. musculus",assemblies:{default:"GCF_000001635.20"}},4641:{commonName:"banana",scientificName:"Musa acuminata",scientificNameAbbr:"M. acuminata",assemblies:{default:"mock"}}},this.chromosomesArray=[],this.bandsToShow=[],this.chromosomes={},this.numChromosomes=0,this.bandData={},this.init()};Ideogram.prototype.getBands=function(content,taxid,chromosomes){var lines={},delimiter,tsvLines,columns,line,stain,chr,i,init,tsvLinesLength,source,start,stop,firstColumn,tmp;if("chrBands"===content.slice(0,8)&&(source="native"),chromosomes instanceof Array&&"object"==typeof chromosomes[0]){for(tmp=[],i=0;i<chromosomes.length;i++)tmp.push(chromosomes[i].name);chromosomes=tmp}if("undefined"==typeof chrBands&&"native"!==source?(delimiter=/\t/,tsvLines=content.split(/\r\n|\n/),init=1):(delimiter=/ /,tsvLines="native"===source?eval(content):content,init=0),firstColumn=tsvLines[0].split(delimiter)[0],source="#chromosome"===firstColumn?"ncbi":"#chrom"===firstColumn?"ucsc":"native",tsvLinesLength=tsvLines.length,"ncbi"===source||"native"===source)for(i=init;i<tsvLinesLength;i++)columns=tsvLines[i].split(delimiter),chr=columns[0],"undefined"!=typeof chromosomes&&chromosomes.indexOf(chr)===-1||(chr in lines==!1&&(lines[chr]=[]),stain=columns[7],columns[8]&&(stain+=columns[8]),line={chr:chr,bp:{start:parseInt(columns[5],10),stop:parseInt(columns[6],10)},iscn:{start:parseInt(columns[3],10),stop:parseInt(columns[4],10)},px:{start:-1,stop:-1,width:-1},name:columns[1]+columns[2],stain:stain,taxid:taxid},lines[chr].push(line));else if("ucsc"===source)for(i=init;i<tsvLinesLength;i++)columns=tsvLines[i].split(delimiter),columns[0]==="chr"+chromosomeName&&(stain=columns[4],"n/a"===stain&&(stain="gpos100"),start=parseInt(columns[1],10),stop=parseInt(columns[2],10),line={chr:columns[0].split("chr")[1],bp:{start:start,stop:stop},iscn:{start:start,stop:stop},px:{start:-1,stop:-1,width:-1},name:columns[3],stain:stain,taxid:taxid},lines[chr].push(line));return lines},Ideogram.prototype.getChromosomeModel=function(t,o,e,n){var r,i,s,a,c,l,h={},d=this.config.chrHeight,u=this.maxLength;if(c=this.coordinateSystem,l="undefined"!=typeof t,l?(h.name=o,h.length=t[t.length-1][c].stop,h.type="nuclear"):h=o,h.chrIndex=n,h.id="chr"+h.name+"-"+e,this.config.fullChromosomeLabels===!0){var m=this.organisms[e].scientificNameAbbr;h.name=m+" chr"+h.name}if(a=h.length,s=0,l)for(var p=0;p<t.length;p++){r=t[p];var f=r[c].stop-r[c].start;i=d*h.length/u[c]*f/a,t[p].px={start:s,stop:s+i,width:i},s=t[p].px.stop,l&&"acen"===r.stain&&"p"===r.name[0]&&(h.pcenIndex=p)}else s=d*h.length/u[c];return h.width=s,h.scale={},this.config.multiorganism===!0?(h.scale.bp=1,h.scale.iscn=d*a/u.bp):(h.scale.bp=d/u.bp,l&&(h.scale.iscn=d/u.iscn)),h.bands=t,h.centromerePosition="",l&&"p"===t[0].name[0]&&"q"===t[1].name[0]&&t[0].bp.stop-t[0].bp.start<2e6&&(h.centromerePosition="telocentric",h.bands=h.bands.slice(1)),l&&1===h.bands.length&&delete h.bands,h},Ideogram.prototype.drawChromosomeLabels=function(){var t=this,o=t._layout.getChromosomeLabelClass(),e=t._layout.getChromosomeSetLabelXPosition(),n=t._layout.getChromosomeSetLabelTranslate();d3.selectAll(t.selector+" .chromosome-set-container").append("text").data(t.chromosomesArray).attr("class","chromosome-set-label "+o).attr("transform",n).attr("x",e).attr("y",function(o,e){return t._layout.getChromosomeSetLabelYPosition(e)}).attr("text-anchor",t._layout.getChromosomeSetLabelAnchor()).each(function(o,e){var n;n=o.name.indexOf(" ")===-1?[o.name]:o.name.match(/^(.*)\s+([^\s]+)$/).slice(1).reverse(),"sex"in t.config&&2===t.config.ploidy&&e===t.sexChromosomes.index&&(n="male"===t.config.sex?["XY"]:["XX"]),d3.select(this).selectAll("tspan").data(n).enter().append("tspan").attr("dy",function(t,o){return o*-1.2+"em"}).attr("x",t._layout.getChromosomeSetLabelXPosition()).attr("class",function(o,e){var n=t.config.fullChromosomeLabels;return 1===e&&n?"italic":null}).text(String)});var r=t._layout.getChromosomeSetLabelTranslate();d3.selectAll(t.selector+" .chromosome-set-container").each(function(o,e){d3.select(this).selectAll(".chromosome").append("text").attr("class","chrLabel").attr("transform",r).attr("x",function(o,e){return t._layout.getChromosomeLabelXPosition(e)}).attr("y",function(o,e){return t._layout.getChromosomeLabelYPosition(e)}).text(function(o,n){return t._ploidy.getAncestor(e,n)}).attr("text-anchor","middle")})},Ideogram.prototype.drawBandLabels=function(t){var o,e,n,r,i,s;i=this,n=[];for(r in t)for(e in t[r])n.push(t[r][e]);var a={};for(chrIndex=0,o=0;o<n.length;o++)chrIndex+=1,s=n[o],e=d3.select(i.selector+" #"+s.id),a[s.id]=[],e.selectAll("text").data(s.bands).enter().append("g").attr("class",function(t,o){return"bandLabel bsbsl-"+o}).attr("transform",function(t){var e=i._layout.getChromosomeBandLabelTranslate(t,o),n=e.x;return a[s.id].push(n+13),e.translate}).append("text").attr("text-anchor",i._layout.getChromosomeBandLabelAnchor(o)).text(function(t){return t.name}),e.selectAll("line.bandLabelStalk").data(s.bands).enter().append("g").attr("class",function(t,o){return"bandLabelStalk bsbsl-"+o}).attr("transform",function(t){var o,e;return o=i.round(t.px.start+t.px.width/2),a[s.id].push(o+13),e=-10,"translate("+o+","+e+")"}).append("line").attr("x1",0).attr("y1",function(){return i._layout.getChromosomeBandTickY1(o)}).attr("x2",0).attr("y2",function(){return i._layout.getChromosomeBandTickY2(o)});for(o=0;o<n.length;o++){s=n[o];var c,l,h,d,u,m,p=a[s.id].length,f=[];for(c=0,m=5,l=0;l<p;l++)d=a[s.id][l],d<c+m==!1?(f.push(l),h!==l&&(prevTextBoxLeft=a[s.id][l],prevTextBoxWidth=36,u=prevTextBoxLeft+prevTextBoxWidth),d<u+m?(h=l,c=u):f.push(l)):(h=l,c=u);var g,y=[],b=f.length;for(g=0;g<b;g++)l=f[g],y.push("#"+s.id+" .bsbsl-"+l);this.bandsToShow=this.bandsToShow.concat(y)}},Ideogram.prototype.rotateChromosomeLabels=function(t,o,e,n){var r,i,s,a,c,l,h,d;if(i=this.config.chrWidth,r=this.config.chrMargin*o,l=this.config.numAnnotTracks,s=this,"undefined"==typeof n||!n.hasOwnProperty("x")||1===n.x&&1===n.y?(a=-8,c=-16,n={x:1,y:1},h=""):(h="scale("+n.x+","+n.y+")",a=-6,c=""===n?-16:-14),"vertical"===e||""===e){var u=o-1;(l>1||""===e)&&(u-=1),chrMargin2=-4,s.config.showBandLabels===!0&&(chrMargin2=s.config.chrMargin+i+26),r=s.config.chrMargin*u,l>1==!1&&(r+=1),c=r+chrMargin2,t.selectAll("text.chrLabel").attr("transform",h).selectAll("tspan").attr("x",a).attr("y",c)}else o-=1,chrMargin2=-i-2,s.config.showBandLabels===!0&&(chrMargin2=s.config.chrMargin+8),d=s.config.annotTracksHeight,"overlay"!==s.config.annotationsLayout&&(d*=2),r=s.config.chrMargin*o,a=-(r+chrMargin2)+3+d,a/=n.x,t.selectAll("text.chrLabel").attr("transform","rotate(-90)"+h).selectAll("tspan").attr("x",a).attr("y",c)},Ideogram.prototype.rotateBandLabels=function(t,o,e){var n,r,i,s,a=this;s=t.selectAll(".bandLabel"),chrWidth=this.config.chrWidth,n=this.config.chrMargin*o,i=t.attr("data-orientation"),"undefined"==typeof e?(e={x:1,y:1},r=""):r="scale("+e.x+","+e.y+")",1===o&&"perspective"in this.config&&"comparative"===this.config.perspective?s.attr("transform",function(t){var o,e;return o=8-n-26,e=a.round(2+t.px.start+t.px.width/2),"rotate(-90)translate("+o+","+e+")"}).selectAll("text").attr("text-anchor","end"):"vertical"===i?s.attr("transform",function(t){var o,e;return o=8-n,e=a.round(2+t.px.start+t.px.width/2),"rotate(-90)translate("+o+","+e+")"}).selectAll("text").attr("transform",r):(s.attr("transform",function(t){var o,r;return o=a.round(-8*e.x+t.px.start+t.px.width/2),r=n-10,"translate("+o+","+r+")"}).selectAll("text").attr("transform",r),t.selectAll(".bandLabelStalk line").attr("transform",r))},Ideogram.prototype.round=function(t){return Math.round(100*t)/100},Ideogram.prototype.drawChromosome=function(t,o,e,n){var r=this.config.chrMargin,i=ModelAdapter.getInstance(t),s=e.append("g").attr("id",t.id).attr("class","chromosome "+i.getCssClass()).attr("transform","translate(0, "+n*r+")");return Chromosome.getInstance(i,this.config,this).render(s,o,n)},Ideogram.prototype.rotateAndToggleDisplay=function(t){if(this.config.taxid){var o=Number(d3.select(t.parentNode).attr("data-set-number")),e=Array.prototype.slice.call(d3.select(t.parentNode).selectAll("g.chromosome")._groups[0]).indexOf(t);return this._layout.rotate(o,e,t)}},Ideogram.prototype.convertBpToPx=function(t,o){var e,n,r,i,s,a,c,l,h,d,u,m,p,f;for(e=0;e<t.bands.length;e++)if(n=t.bands[e],a=this._bandsXOffset,m=n.bp.start,p=n.bp.stop,f=p-m,h=n.iscn.start,d=n.iscn.stop,u=d-h,c=n.px.start,l=n.px.width,o>=m&&o<=p)return r=u/f,i=h+(o-m)*r,s=a+c+l*(i-h)/u;throw new Error("Base pair out of range.  bp: "+o+"; length of chr"+t.name+": "+n.bp.stop)},Ideogram.prototype.convertPxToBp=function(t,o){var e,n,r,i,s,a,c,l,h,d;for(e=0;e<t.bands.length;e++)if(n=t.bands[e],s=n.px.start,a=n.px.stop,c=n.iscn.start,l=n.iscn.stop,o>=s&&o<=a)return d=l-c,pxLength=a-s,h=n.bp.stop-n.bp.start,r=d/pxLength,i=c+(o-s)*r,bp=n.bp.start+h*(i-c)/d,Math.round(bp);throw new Error("Pixel out of range.  px: "+bp+"; length of chr"+t.name+": "+a)},Ideogram.prototype.drawSynteny=function(t){var o,e,n,r,i,s,a,c=(new Date).getTime(),l=this;for(n=d3.select(l.selector).insert("g",":first-child").attr("class","synteny"),r=0;r<t.length;r++){regions=t[r],o=regions.r1,e=regions.r2,i="#CFC","color"in regions&&(i=regions.color),s=1,"opacity"in regions&&(s=regions.opacity),o.startPx=this.convertBpToPx(o.chr,o.start),o.stopPx=this.convertBpToPx(o.chr,o.stop),e.startPx=this.convertBpToPx(e.chr,e.start),e.stopPx=this.convertBpToPx(e.chr,e.stop),a=o.chr.id+"_"+o.start+"_"+o.stop+"___"+e.chr.id+"_"+e.start+"_"+e.stop,syntenicRegion=n.append("g").attr("class","syntenicRegion").attr("id",a).on("click",function(){var t=this,o=d3.selectAll(l.selector+" .syntenicRegion").filter(function(){return this!==t});o.classed("hidden",!o.classed("hidden"))}).on("mouseover",function(){var t=this;d3.selectAll(l.selector+" .syntenicRegion").filter(function(){return this!==t}).classed("ghost",!0)}).on("mouseout",function(){d3.selectAll(l.selector+" .syntenicRegion").classed("ghost",!1)});var h=this._layout.getChromosomeSetYTranslate(0),d=this._layout.getChromosomeSetYTranslate(1)-l.config.chrWidth;syntenicRegion.append("polygon").attr("points",h+", "+o.startPx+" "+h+", "+o.stopPx+" "+d+", "+e.stopPx+" "+d+", "+e.startPx).attr("style","fill: "+i+"; fill-opacity: "+s),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",h).attr("x2",d).attr("y1",o.startPx).attr("y2",e.startPx),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",h).attr("x2",d).attr("y1",o.stopPx).attr("y2",e.stopPx)}var u=(new Date).getTime();l.debug&&console.log("Time in drawSyntenicRegions: "+(u-c)+" ms")},Ideogram.prototype.initAnnotSettings=function(){if(this.config.annotationsPath||this.config.localAnnotationsPath||this.annots||this.config.annotations){if(!this.config.annotationHeight){var t=Math.round(this.config.chrHeight/100);this.config.annotationHeight=t}this.config.annotationTracks?this.config.numAnnotTracks=this.config.annotationTracks.length:this.config.numAnnotTracks=1,this.config.annotTracksHeight=this.config.annotationHeight*this.config.numAnnotTracks,"undefined"==typeof this.config.barWidth&&(this.config.barWidth=3)}else this.config.annotTracksHeight=0;"undefined"==typeof this.config.annotationsColor&&(this.config.annotationsColor="#F00")},Ideogram.prototype.drawAnnots=function(t){var o,e,n,r,i,s,a=this,c=[],l=a.chromosomes[a.config.taxid];if("annots"in t[0])return a.drawProcessedAnnots(t);for(s in l)c.push({chr:s,annots:[]});for(o=0;o<t.length;o++)for(n=t[o],e=0;e<c.length;e++)if(n.chr===c[e].chr){r=[n.name,n.start,n.stop-n.start],"color"in n&&r.push(n.color),"shape"in n&&r.push(n.shape),c[e].annots.push(r);break}i=["name","start","length"],"color"in t[0]&&i.push("color"),"shape"in t[0]&&i.push("shape"),a.rawAnnots={keys:i,annots:c},a.annots=a.processAnnotData(a.rawAnnots),a.drawProcessedAnnots(a.annots)},Ideogram.prototype.processAnnotData=function(t){var o,e,n,r,i,s,a,c,l,h,d,u,m,p=this;for(o=t.keys,t=t.annots,i=[],e=0;e<t.length;e++)for(s=t[e],i.push({chr:s.chr,annots:[]}),n=0;n<s.annots.length;n++){a=s.chr,l=s.annots[n],r={};for(var f=0;f<o.length;f++)r[o[f]]=l[f];r.stop=r.start+r.length,c=p.chromosomes[p.config.taxid][a],h=p.convertBpToPx(c,r.start),d=p.convertBpToPx(c,r.stop),u=Math.round((h+d)/2)-28,m=p.config.annotationsColor,p.config.annotationTracks?(r.trackIndex=l[3],m=p.config.annotationTracks[r.trackIndex].color):r.trackIndex=0,"color"in r&&(m=r.color),r.chr=a,r.chrIndex=e,r.px=u,r.startPx=h-30,r.stopPx=d-30,r.color=m,i[e].annots.push(r)}return i},Ideogram.prototype.getHistogramBars=function(t){var o,e,n,r,i,s,a,c,l,h,d,u,m,p,f,g,y,b,_=(new Date).getTime(),x=!1,v=this;d=[],f=v.config.barWidth,r=v.chromosomes[v.config.taxid],y=v.config.annotationsColor,b="histogramScaling"in v.config?v.config.histogramScaling:"relative","undefined"==typeof v.maxAnnotsPerBar&&(v.maxAnnotsPerBar={},x=!0);for(n in r){for(chrModel=r[n],l=chrModel.chrIndex,lastBand=chrModel.bands[chrModel.bands.length-1],i=lastBand.px.stop,numBins=Math.round(i/f),u={chr:n,annots:[]},o=0;o<numBins;o++)s=o*f-v.bump,bp=v.convertPxToBp(chrModel,s+v.bump),u.annots.push({bp:bp,px:s-v.bump,count:0,chrIndex:l,chrName:n,color:y,annots:[]});d.push(u)}for(n in t)for(a=t[n].annots,c=t[n].chr,chrModel=r[c],l=chrModel.chrIndex-1,barAnnots=d[l].annots,o=0;o<a.length;o++)for(h=a[o],s=h.px-v.bump,e=0;e<barAnnots.length;e++)if(m=barAnnots[e].px,p=m+f,e===barAnnots.length-1&&(p+=f),s>=m&&s<p){d[l].annots[e].count+=1,d[l].annots[e].annots.push(h);break}if(x===!0||"relative"===b){for(g=0,o=0;o<d.length;o++)for(t=d[o].annots,e=0;e<t.length;e++)barCount=t[e].count,barCount>g&&(g=barCount);v.maxAnnotsPerBar[n]=g}for(o=0;o<d.length;o++)for(t=d[o].annots,e=0;e<t.length;e++)barCount=t[e].count,height=barCount/v.maxAnnotsPerBar[n]*v.config.chrMargin,d[o].annots[e].height=height;var C=(new Date).getTime();return v.debug&&console.log("Time spent in getHistogramBars: "+(C-_)+" ms"),v.bars=d,d},Ideogram.prototype.fillAnnots=function(t){var o,e,n,r,i,s,a;for(o=[],e=[],n=this.chromosomesArray,r=0;r<n.length;r++)i=n[r].name,e.push(i),o.push({chr:i,annots:[]});for(r=0;r<t.length;r++)s=t[r],a=e.indexOf(s.chr),a!==-1&&(o[a]=s);return o},Ideogram.prototype.drawProcessedAnnots=function(t){var o,e,n,r,i,s,a,c,l,h,d,u,m=this;chrMargin=this.config.chrMargin,o=this.config.chrWidth,e="tracks",this.config.annotationsLayout&&(e=this.config.annotationsLayout),"histogram"===e&&(t=m.getHistogramBars(t)),n=m.config.annotationHeight,r="l -"+n+" "+2*n+" l "+2*n+" 0 z",s=n,i="m -"+s+", "+s+"a "+s+","+s+" 0 1,0 "+2*s+",0a "+s+","+s+" 0 1,0 -"+2*s+",0",u=m.fillAnnots(t),a=d3.selectAll(m.selector+" .chromosome").data(u).selectAll("path.annot").data(function(t){return t.annots}).enter(),"tracks"===e?a.append("g").attr("id",function(t){return t.id}).attr("class","annot").attr("transform",function(t){var o=m.config.chrWidth+t.trackIndex*n*2;return"translate("+t.px+","+o+")"}).append("path").attr("d",function(t){return t.shape&&"triangle"!==t.shape?"circle"===t.shape?i:void 0:"m0,0"+r}).attr("fill",function(t){return t.color}):"overlay"===e?a.append("polygon").attr("id",function(t){return t.id}).attr("class","annot").attr("points",function(t){return t.stopPx-t.startPx>1?(c=t.startPx,l=t.stopPx):(c=t.px-.5,l=t.px+.5),h=o,d=0,c+","+h+" "+l+","+h+" "+l+","+d+" "+c+","+d}).attr("fill",function(t){return t.color}):"histogram"===e&&a.append("polygon").attr("class","annot").attr("points",function(t){c=t.px+m.bump,l=t.px+m.config.barWidth+m.bump,h=o,d=o+t.height;var e=m.chromosomesArray[t.chrIndex-1].width;return l>e&&(l=e),c+","+h+" "+l+","+h+" "+l+","+d+" "+c+","+d}).attr("fill",function(t){return t.color}),m.onDrawAnnotsCallback&&m.onDrawAnnotsCallback()},Ideogram.prototype.onBrushMove=function(){call(this.onBrushMoveCallback)},Ideogram.prototype.createBrush=function(t,o){function e(){var t=d3.event.selection.map(d.invert),o=Math.floor(t[0]),e=Math.ceil(t[1]);i.selectedRegion={from:o,to:e,extent:e-o},i.onBrushMove&&i.onBrushMoveCallback()}var n,r,i=this,s=i.config.chrWidth+6.5,a=i.config.chrHeight,c=i.chromosomesArray[0],l=c.bands[c.bands.length-1].bp.stop,h=this._layout.getMargin().left,d=d3.scaleLinear().domain([0,d3.max(c.bands,function(t){return t.bp.stop})]).range([h,d3.max(c.bands,function(t){return t.px.stop})+h]);"undefined"==typeof t&&(t=Math.floor(l/10)),"undefined"==typeof right&&(o=Math.ceil(2*t)),n=i.convertBpToPx(c,t),r=i.convertBpToPx(c,o),i.selectedRegion={from:t,to:o,extent:o-t},i.brush=d3.brushX().extent([[h,0],[a+h,s]]).on("brush",e);var u=this._layout.getChromosomeSetYTranslate(0),m=u+(i.config.chrWidth-s)/2;d3.select(i.selector).append("g").attr("class","brush").attr("transform","translate(0, "+m+")").call(i.brush).call(i.brush.move,[n,r])},Ideogram.prototype.onLoad=function(){call(this.onLoadCallback)},Ideogram.prototype.onDrawAnnots=function(){call(this.onDrawAnnotsCallback)},Ideogram.prototype.getBandColorGradients=function(){var t,o,e,n,r,i,s="";t=[["gneg","#FFF","#FFF","#DDD"],["gpos25","#C8C8C8","#DDD","#BBB"],["gpos33","#BBB","#BBB","#AAA"],["gpos50","#999","#AAA","#888"],["gpos66","#888","#888","#666"],["gpos75","#777","#777","#444"],["gpos100","#444","#666","#000"],["acen","#FEE","#FEE","#FDD"],["noBands","#BBB","#BBB","#AAA"]];for(var a=0;a<t.length;a++)o=t[a][0],e=t[a][1],n=t[a][2],r=t[a][3],s+='<linearGradient id="'+o+'" x1="0%" y1="0%" x2="0%" y2="100%">',s+="gneg"===o?'<stop offset="70%" stop-color="'+n+'" /><stop offset="95%" stop-color="'+r+'" /><stop offset="100%" stop-color="'+e+'" />':'<stop offset="5%" stop-color="'+e+'" /><stop offset="15%" stop-color="'+n+'" /><stop offset="60%" stop-color="'+r+'" />',s+="</linearGradient>";return s+='<pattern id="stalk" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#CCE" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#88B; stroke-width:0.7;" /></pattern><pattern id="gvar" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(-30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#DDF" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#99C; stroke-width:0.7;" /></pattern>',s="<defs>"+s+"</defs>",i='<style>.gneg {fill: url("#gneg")} .gpos25 {fill: url("#gpos25")} .gpos33 {fill: url("#gpos33")} .gpos50 {fill: url("#gpos50")} .gpos66 {fill: url("#gpos66")} .gpos75 {fill: url("#gpos75")} .gpos100 {fill: url("#gpos100")} .gpos {fill: url("#gpos100")} .acen {fill: url("#acen")} .stalk {fill: url("#stalk")} .gvar {fill: url("#gvar")} .noBands {fill: url("#noBands")} .chromosome {fill: url("#noBands")} </style>',s=i+s},Ideogram.prototype.getTaxidFromEutils=function(t){var o,e,n,r=this;o=r.config.organism,e=r.esearch+"&db=taxonomy&term="+o,d3.json(e,function(o){return n=o.esearchresult.idlist[0],t(n)})},Ideogram.prototype.getTaxids=function(callback){var ideo=this,taxid,taxids,org,orgs,i,taxidInit,tmpChrs,assembly,chromosomes,multiorganism;if(taxidInit="taxid"in ideo.config,ideo.config.multiorganism="organism"in ideo.config&&ideo.config.organism instanceof Array||taxidInit&&ideo.config.taxid instanceof Array,multiorganism=ideo.config.multiorganism,"organism"in ideo.config){for(orgs=multiorganism?ideo.config.organism:[ideo.config.organism],taxids=[],tmpChrs={},i=0;i<orgs.length;i++){org=orgs[i];for(taxid in ideo.organisms)ideo.organisms[taxid].commonName.toLowerCase()===org&&(taxids.push(taxid),multiorganism&&(tmpChrs[taxid]=ideo.config.chromosomes[org]))}0===taxids.length?(promise=new Promise(function(t){ideo.getTaxidFromEutils(t)}),promise.then(function(data){var organism=ideo.config.organism,dataDir=ideo.config.dataDir,urlOrg=organism.replace(" ","-");taxid=data,taxids.push(taxid),ideo.config.taxids=taxids,ideo.organisms[taxid]={commonName:"",scientificName:ideo.config.organism,scientificNameAbbr:""};var fullyBandedTaxids=["9606","10090","10116"];fullyBandedTaxids.indexOf(taxid)!==-1&&ideo.config.showFullyBanded===!1&&(urlOrg+="-no-bands");var chromosomesUrl=dataDir+urlOrg+".js",promise=new Promise(function(t,o){d3.request(chromosomesUrl).get(function(e,n){e&&o(Error(e)),t(n)})});return promise.then(function(data){var asmAndChrArray=[],chromosomes=[],seenChrs={},chr;eval(data.response),asmAndChrArray.push("");for(var i=0;i<chrBands.length;i++)chr=chrBands[i].split(" ")[0],chr in seenChrs||(chromosomes.push({name:chr,type:"nuclear"}),seenChrs[chr]=1);return chromsomes=chromosomes.sort(ideo.sortChromosomes),asmAndChrArray.push(chromosomes),ideo.coordinateSystem="iscn",asmAndChrArray},function(){return new Promise(function(t){ideo.coordinateSystem="bp",ideo.getAssemblyAndChromosomesFromEutils(t)})})}).then(function(t){assembly=t[0],chromosomes=t[1],ideo.config.chromosomes=chromosomes,ideo.organisms[taxid].assemblies={default:assembly},callback(taxids)})):(ideo.config.taxids=taxids,multiorganism&&(ideo.config.chromosomes=tmpChrs),callback(taxids))}else multiorganism?(ideo.coordinateSystem="bp",taxidInit&&(taxids=ideo.config.taxid)):(taxidInit&&(taxids=[ideo.config.taxid]),ideo.config.taxids=taxids),callback(taxids)},Ideogram.prototype.sortChromosomes=function(t,o){var e="nuclear"===t.type,n="nuclear"===o.type,r="chloroplast"===t.type,i="chloroplast"===o.type,s="mitochondrion"===t.type,a="mitochondrion"===o.type;return e&&n?naturalSort(t.name,o.name):!e&&n?1:s&&i?1:r&&a?-1:s||r||!a&&!i?void 0:-1},Ideogram.prototype.getAssemblyAndChromosomesFromEutils=function(t){var o,e,n,r,i,s,a,c,l,h,d,u,m,p,f,g,y,b=this;organism=b.config.organism,o=[],n=[],r=b.esearch+"&db=assembly&term=%22"+organism+"%22[organism]AND%20(%22latest%20refseq%22[filter])%20AND%20(%22chromosome%20level%22[filter]%20OR%20%22complete%20genome%22[filter])";var _=d3.promise.json(r);_.then(function(t){return i=t.esearchresult.idlist[0],s=b.esummary+"&db=assembly&id="+i,d3.promise.json(s)}).then(function(t){a=t.result[i].rsuid,e=t.result[i].assemblyaccession,o.push(e);var n="&db=nuccore&linkname=gencoll_nuccore_chr&from_uid="+a;return c=b.elink+n,d3.promise.json(c)}).then(function(t){return l=t.linksets[0].linksetdbs[0].links.join(","),h=b.esummary+"&db=nucleotide&id="+l,d3.promise.json(h)}).then(function(e){d=e.result;for(var r in d)if(u=d[r],"uids"!==r){if("mitochondrion"===u.genome){if(!b.config.showNonNuclearChromosomes)continue;y=u.genome,m=u.subtype.split("|").indexOf("plasmid"),p=m===-1?"MT":u.subname.split("|")[m]}else if("chloroplast"===u.genome||"plastid"===u.genome){if(y="chloroplast",!b.config.showNonNuclearChromosomes)continue;p="CP"}else y="nuclear",m=u.subtype.split("|").indexOf("chromosome"),p=u.subname.split("|")[m],"undefined"!=typeof p&&"chr"===p.substr(0,3)&&(p=p.substr(3));f=u.slen,g={name:p,length:f,type:y},n.push(g)}return n=n.sort(b.sortChromosomes),o.push(n),b.coordinateSystem="bp",t(o)})},Ideogram.prototype.drawSexChromosomes=function(t,o,e,n,r,i){var s,a,c,l,h,d,u,m=this;for(u="male"===m.config.sex?[1,0]:[0,0],d=0;d<u.length;d++)h=u[d]+r,s=i[h],a=t[h],c=m.getChromosomeModel(a,s,o,h),l=m.drawChromosome(c,r,e,d),n.append("clipPath").attr("id",c.id+"-chromosome-set-clippath").selectAll("path").data(l).enter().append("path").attr("d",function(t){return t.path}).attr("class",function(t){return t.class})},Ideogram.prototype.initDrawChromosomes=function(t){var o,e,n,r,i,s,a,c,l,h=this,d=h.config.taxids,u=0,m=0;for(c=d3.select(h.selector+" defs"),n=0;n<d.length;n++){for(o=d[n],i=h.config.chromosomes[o],h.chromosomes[o]={},h.setSexChromosomes(i),r=0;r<i.length;r++)if(s=i[r],e=t[u],u+=1,a=h.getChromosomeModel(e,s,o,u),h.chromosomes[o][s]=a,h.chromosomesArray.push(a),!("sex"in h.config&&(2===h.config.ploidy&&h.sexChromosomes.index+2===u||"female"===h.config.sex&&"Y"===a.name))){l=h._layout.getChromosomeSetTranslate(m),m+=1;var p=d3.select(h.selector).append("g").attr("class","chromosome-set-container").attr("data-set-number",r).attr("transform",l).attr("id",a.id+"-chromosome-set");if("sex"in h.config&&2===h.config.ploidy&&h.sexChromosomes.index+1===u)h.drawSexChromosomes(t,o,p,c,r,i);else{var f,g=1;h.config.ploidy>1&&(g=this._ploidy.getChromosomesNumber(r));for(var y=0;y<g;y++)f=h.drawChromosome(a,u-1,p,y);c.append("clipPath").attr("id",a.id+"-chromosome-set-clippath").selectAll("path").data(f).enter().append("path").attr("d",function(t){return t.path}).attr("class",function(t){return t.class})}}h.config.showBandLabels===!0&&h.drawBandLabels(h.chromosomes)}},Ideogram.prototype.getSvg=function(){return d3.select(this.selector).node()},Ideogram.prototype.setSexChromosomes=function(t){if(2===this.config.ploidy&&this.config.sex){var o,e,n=this,r={X:1,Y:1};"female"===n.config.sex?"Y":"";for(n.sexChromosomes.list=[],e=0;e<t.length;e++)o=t[e],"male"===n.config.sex&&o in r?(n.sexChromosomes.list.push(o),n.sexChromosomes.index||(n.sexChromosomes.index=e)):"X"===o&&(n.sexChromosomes.list.push(o,o),n.sexChromosomes.index=e)}},Ideogram.prototype.processBandData=function(){var t,o,e,n,r,s,a,c,l,h,d,u,m,p=this;if(t=[],maxLength=0,p.config.multiorganism===!0)for(p.coordinateSystem="bp",d=p.config.taxids,i=0;i<d.length;i++)h=d[i];else"undefined"==typeof p.config.taxid&&(p.config.taxid=p.config.taxids[0]),h=p.config.taxid,d=[h],p.config.taxids=d;"chromosomes"in p.config&&(u=p.config.chromosomes),p.config.multiorganism&&(m=u),p.config.chromosomes={};var f=(new Date).getTime();for(o=0;o<d.length;o++)if(h=d[o],p.config.multiorganism&&(u=m[h]),"iscn"===p.coordinateSystem||p.config.multiorganism)for(c=p.bandData[h],l=p.getBands(c,h,u),u=Object.keys(l).sort(function(t,o){return naturalSort(t,o)}),p.config.chromosomes[h]=u.slice(),p.numChromosomes+=p.config.chromosomes[h].length,e=0;e<u.length;e++)n=u[e],r=l[n],t.push(r),s={iscn:r[r.length-1].iscn.stop,bp:r[r.length-1].bp.stop},s.iscn>p.maxLength.iscn&&(p.maxLength.iscn=s.iscn),s.bp>p.maxLength.bp&&(p.maxLength.bp=s.bp);else if("bp"===p.coordinateSystem)for(p.config.chromosomes[h]=u.slice(),p.numChromosomes+=p.config.chromosomes[h].length,e=0;e<u.length;e++)a=u[e],a.length>p.maxLength.bp&&(p.maxLength.bp=a.length);var g=(new Date).getTime();return p.debug&&console.log("Time in processBandData: "+(g-f)+" ms"),t},Ideogram.prototype.init=function(){function writeContainer(){if(ideo.config.annotationsPath&&d3.json(ideo.config.annotationsPath,function(t){ideo.rawAnnots=t}),"ploidyDesc"in ideo.config&&"string"==typeof ideo.config.ploidyDesc){for(var t=[],o=0;o<ideo.numChromosomes;o++)t.push(ideo.config.ploidyDesc);ideo.config.ploidyDesc=t}ideo._ploidy=new Ploidy(ideo.config),ideo._layout=Layout.getInstance(ideo.config,ideo),svgClass="",ideo.config.showChromosomeLabels&&(svgClass+="horizontal"===ideo.config.orientation?"labeledLeft ":"labeled "),ideo.config.annotationsLayout&&"overlay"===ideo.config.annotationsLayout&&(svgClass+="faint");var e=ideo.getBandColorGradients(),n=ideo._layout.getWidth(taxid),r=ideo._layout.getHeight(taxid);d3.select(ideo.config.container).append("div").append("svg").attr("id","_ideogram").attr("class",svgClass).attr("width",n).attr("height",r).html(e),finishInit()}function finishInit(){function t(){"undefined"!=typeof ideo.timeout&&window.clearTimeout(ideo.timeout),ideo.annots=ideo.processAnnotData(ideo.rawAnnots),ideo.drawProcessedAnnots(ideo.annots),"undefined"!=typeof crossfilter&&ideo.initCrossFilter&&ideo.initCrossFilter()}try{var o,e=(new Date).getTime();if(ideo.initDrawChromosomes(bandsArray),ideo.config.annotationsPath&&(ideo.rawAnnots?t():!function o(){ideo.timeout=setTimeout(function(){ideo.rawAnnots?t():o()},50)}()),ideo.config.showBandLabels===!0){var n=ideo.bandsToShow.join(","),r=(new Date).getTime();d3.selectAll(ideo.selector+" .bandLabel, .bandLabelStalk").style("display","none"),d3.selectAll(n).style("display","");var i=(new Date).getTime();if(ideo.debug&&console.log("Time in showing bands: "+(i-r)+" ms"),"vertical"===ideo.config.orientation){var s;for(o=0;o<ideo.chromosomesArray.length;o++)s="#"+ideo.chromosomesArray[o].id,ideo.rotateChromosomeLabels(d3.select(s),o)}}ideo.config.showChromosomeLabels===!0&&ideo.drawChromosomeLabels(ideo.chromosomes),ideo.config.brush===!0&&ideo.createBrush(),ideo.config.annotations&&ideo.drawAnnots(ideo.config.annotations);var a=(new Date).getTime();ideo.debug&&console.log("Time in drawChromosome: "+(a-e)+" ms");var c=(new Date).getTime();ideo.debug&&console.log("Time constructing ideogram: "+(c-t0)+" ms"),ideo.onLoadCallback&&ideo.onLoadCallback(),"rotatable"in ideo.config&&ideo.config.rotatable===!1?d3.selectAll(ideo.selector+" .chromosome").style("cursor","default"):d3.selectAll(ideo.selector+" .chromosome").on("click",function(){ideo.rotateAndToggleDisplay(this)})}catch(t){throw t}}var taxid,i,svgClass,ideo=this,t0=(new Date).getTime(),bandsArray=[],numBandDataResponses=0,resolution=this.config.resolution,accession,promise=new Promise(function(t){ideo.getTaxids(t)});promise.then(function(taxids){taxid=taxids[0],ideo.config.taxid=taxid,ideo.config.taxids=taxids;var assemblies,bandFileName,bandDataFileNames={9606:"",10090:""};for(i=0;i<taxids.length;i++)taxid=String(taxids[i]),ideo.config.assembly||(ideo.config.assembly="default"),assemblies=ideo.organisms[taxid].assemblies,accession=assemblies[ideo.config.assembly],bandFileName=[],bandFileName.push(slugify(ideo.organisms[taxid].scientificName)),accession!==assemblies.default&&bandFileName.push(accession),"9606"!==taxid||accession===assemblies.default&&850===resolution||bandFileName.push(resolution),bandFileName=bandFileName.join("-")+".js","9606"!==taxid&&"10090"!==taxid||(bandDataFileNames[taxid]=bandFileName),"undefined"==typeof chrBands&&taxid in bandDataFileNames?d3.request(ideo.config.dataDir+bandDataFileNames[taxid]).on("beforesend",function(t){t.taxid=taxid}).get(function(error,data){eval(data.response),ideo.bandData[data.taxid]=chrBands,numBandDataResponses+=1,numBandDataResponses===taxids.length&&(bandsArray=ideo.processBandData(),writeContainer())}):("undefined"!=typeof chrBands&&(ideo.bandData[taxid]=chrBands),bandsArray=ideo.processBandData(),writeContainer())})},Ideogram.prototype.unpackAnnots=function(){var t,o,e,n=[],r=this,i=r.annots;for(e=0;e<i.length;e++)t=i[e],o=t.annots,n=n.concat(o);return n},Ideogram.prototype.packAnnots=function(t){var o,e,n,r=[],i=this,s=i.annots;for(o in s)r.push({chr:s[o].chr,annots:[]});for(n=0;n<t.length;n++)e=t[n],r[e.chrIndex].annots.push(e);return r},Ideogram.prototype.initCrossFilter=function(){var t,o,e=this,n=e.rawAnnots.keys;for(e.unpackedAnnots=e.unpackAnnots(),e.crossfilter=crossfilter(e.unpackedAnnots),e.annotsByFacet={},e.facets=n.slice(3,n.length),t=0;t<e.facets.length;t++)o=e.facets[t],e.annotsByFacet[o]=e.crossfilter.dimension(function(t){return t[o]})},Ideogram.prototype.filterAnnots=function(t){var o,e,n,r,i=Date.now(),s={},a=this;if(0===Object.keys(t).length)n=a.unpackedAnnots;else{for(o=0;o<a.facets.length;o++)e=a.facets[o],r=e in t?function(o){if(o in t[e])return!0}:null,a.annotsByFacet[e].filter(r),s[e]=a.annotsByFacet[e].group().top(1/0);n=a.annotsByFacet[e].top(1/0)}for(o<0;o<a.facets.length;o++)a.annotsByFacet[e].filterAll();return n=a.packAnnots(n),d3.selectAll(a.selector+" polygon.annot").remove(),a.drawAnnots(n),console.log("Time in filterAnnots: "+(Date.now()-i)+" ms"),s},ChromosomeUtil.prototype.getLabel=function(){var t=d3.select(this._node).select("text.chrLabel").text();return t},ChromosomeUtil.prototype.getSetLabel=function(){var t=d3.select(this._node.parentNode).select("text.chromosome-set-label").text();return t};
//# sourceMappingURL=ideogram.min.js.map
